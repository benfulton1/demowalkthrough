<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0" name="viewport"/>
<title>Interior Elite Demolition Walkthrough v1.6</title>
<!-- Montserrat font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
  /* (Your existing styles unchanged) */
  body { font-family: 'Montserrat', sans-serif; background: #f4f4f4; color: #333; margin: 0; padding: 0; }
  .header { background: #E65C00; color: #fff; display: flex; align-items: center; padding: 10px 20px; }
  .header img { height: 40px; margin-right: 15px; }
  .header h1 { font-size: 1.5em; margin: 0; }
  .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  h2 { text-align: center; color: #E65C00; margin-bottom: 20px; }
  fieldset { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; padding: 15px; }
  legend { font-weight: 600; color: #444; font-size: 1.1em; }
  label { display: block; margin-bottom: 6px; font-weight: 500; }
  input[type="text"], input[type="tel"], textarea, select { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; }
  textarea { min-height: 60px; resize: vertical; }
  .btn { display: block; width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; margin-bottom: 12px; }
  .btn-primary { background: #E65C00; color: #fff; }
  .btn-primary:hover { background: #cc5000; }
  .btn-secondary { background: #007ACC; color: #fff; }
  .btn-secondary:hover { background: #006bb3; }
  .btn-custom { background: #444; color: #fff; }
  .btn-custom:hover { background: #333; }
  .personnel-item, .checklist-item, .task-item { display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
  .personnel-item select { flex: 0 0 30%; margin-right: 10px; }
  .personnel-item input { flex: 0 0 calc(35% - 10px); margin-right: 10px; }
  .checklist-item label, .task-item label { flex: 1; display: flex; align-items: center; }
  .checklist-item label input, .task-item label input { margin-right: 8px; }
  .note-input { width: 100%; padding: 6px; margin-top: 6px; border: 1px solid #ccc; border-radius: 4px; display: none; }
  .task-controls { margin-left: auto; }
  .task-controls select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
</head>
<body>
<header class="header">
  <img alt="Interior Elite Logo" src="https://kamloopsbuilders.ca/assets/logo.png"/>
  <h1>Interior Elite Contracting</h1>
</header>
<div class="container" id="mainContainer">
  <h2>Demolition Walkthrough v1.6</h2>
  <form id="demoForm">
    <fieldset>
      <legend>Project Info</legend>
      <label>Site Address<input id="siteAddress" placeholder="Enter site address" type="text"/></label>
      <label>Client Name<input id="clientName" placeholder="Enter client name" type="text"/></label>
      <button class="btn btn-custom" id="captureLocationBtn" type="button">Capture Site Location</button>
      <div id="siteLocationDisplay" style="margin-bottom:12px;font-size:0.9em;color:#555;"></div>
    </fieldset>
    <fieldset>
      <legend>Personnel on Site</legend>
      <button class="btn btn-primary" id="addPersonnelBtn" type="button">+ Add Personnel</button>
      <div id="personnelContainer"></div>
    </fieldset>
    <fieldset>
      <legend>Site Conditions</legend>
      <div id="siteConditionsList"></div>
    </fieldset>
    <fieldset>
      <legend>Site Security</legend>
      <div id="siteSecurityList"></div>
    </fieldset>
    <fieldset>
      <legend>Special Client Requests</legend>
      <div id="specialRequestsList"></div>
    </fieldset>
    <fieldset>
      <legend>Rooms &amp; Tasks</legend>
      <button class="btn btn-primary" id="addRoomBtn" type="button">+ Add Room</button>
      <div id="roomsContainer"></div>
    </fieldset>
    <button class="btn btn-secondary" id="toPdfBtn" type="button">Convert to PDF</button>
    <button class="btn btn-secondary" id="toWorkOrderBtn" type="button">Convert to Work Order</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // === persistence helper functions ===
  function saveCustomTasks(roomIdx) {
    const tasks = Array.from(document.querySelectorAll(`#tasks-${roomIdx} .task-item`))
      .filter(item => item.querySelector('input[type=text]'))
      .map(item => ({
        text: item.querySelector('input[type=text]').value,
        checked: item.querySelector('input[type=checkbox]').checked,
        disposition: item.querySelector('select').value || ''
      }));
    localStorage.setItem(`room-${roomIdx}-customTasks`, JSON.stringify(tasks));
  }
  function loadCustomTasks(roomIdx) {
    const data = JSON.parse(localStorage.getItem(`room-${roomIdx}-customTasks`) || '[]');
    data.forEach(td => {
      addCustomTask(roomIdx);
      const last = document.querySelector(`#tasks-${roomIdx} .task-item:last-child`);
      const textInp = last.querySelector('input[type=text]');
      const cb = last.querySelector('input[type=checkbox]');
      const sel = last.querySelector('select');
      textInp.value = td.text;
      cb.checked = td.checked;
      if (td.checked) sel.style.display = 'block';
      sel.value = td.disposition;
    });
  }
  function saveRoomPhoto(roomIdx, dataURL) {
    localStorage.setItem(`room-${roomIdx}-photo`, dataURL);
  }
  function loadRoomPhoto(roomIdx) {
    return localStorage.getItem(`room-${roomIdx}-photo`);
  }
  function insertPhotoPreview(idx, dataURL) {
    const fs = document.getElementById(`room-${idx}`);
    let img = fs.querySelector('img.room-photo-preview');
    if (!img) {
      img = document.createElement('img');
      img.className = 'room-photo-preview';
      img.style = 'max-width:150px;display:block;margin:10px 0;border:1px solid #ccc;';
      fs.appendChild(img);
    }
    img.src = dataURL;
  }

  // === your constants & generateChecklist logic unchanged ===
  // ... (omit here for brevity, same as existing)

  // initialize checklist
  // generateChecklist etc.

  // Personnel
  let personCount = 0;
  document.getElementById('addPersonnelBtn').addEventListener('click', () => {
    const idx = personCount++;
    const div = document.createElement('div'); div.className = 'personnel-item';
    const sel = document.createElement('select'); sel.name = `personnel[${idx}][role]`;
    peopleTypes.forEach(pt => {
      const o = document.createElement('option'); o.value = pt; o.textContent = pt; sel.append(o);
    });
    const inName = document.createElement('input'); inName.type = 'text'; inName.name = `personnel[${idx}][name]`; inName.placeholder = 'Name';
    const inPhone = document.createElement('input'); inPhone.type = 'tel'; inPhone.name = `personnel[${idx}][phone]`; inPhone.placeholder = 'Phone';
    div.append(sel, inName, inPhone);
    document.getElementById('personnelContainer').append(div);
  });

  // Rooms and task logic unchanged until room creation:
  let roomCount = 0;
  document.getElementById('addRoomBtn').addEventListener('click', () => {
    const idx = roomCount++;
    const fs = document.createElement('fieldset'); fs.id = `room-${idx}`;
    const lg = document.createElement('legend'); lg.textContent = `Room ${idx+1}`; fs.append(lg);
    const sel = document.createElement('select'); sel.name = `rooms[${idx}][type]`;
    roomList.forEach(r => {
      const o = document.createElement('option'); o.value = r; o.textContent = r; sel.append(o);
    });
    sel.addEventListener('change', () => {
      renderTasks(idx, sel.value);
      loadCustomTasks(idx);
      const photoData = loadRoomPhoto(idx);
      if (photoData) insertPhotoPreview(idx, photoData);
    });
    fs.append(sel);

    // photo input + listener
    const photo = document.createElement('input');
    photo.type = 'file';
    photo.accept = 'image/*';
    photo.capture = 'environment';
    photo.name = `rooms[${idx}][photo]`;
    photo.addEventListener('change', () => {
      const file = photo.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        saveRoomPhoto(idx, e.target.result);
        insertPhotoPreview(idx, e.target.result);
      };
      reader.readAsDataURL(file);
    });
    fs.append(photo);

    const tasksDiv = document.createElement('div');
    tasksDiv.id = `tasks-${idx}`;
    fs.append(tasksDiv);

    const btnCustom = document.createElement('button');
    btnCustom.type = 'button';
    btnCustom.className = 'btn btn-custom';
    btnCustom.textContent = '+ Custom Task';
    btnCustom.addEventListener('click', () => {
      addCustomTask(idx);
      saveCustomTasks(idx);
    });
    fs.append(btnCustom);

    document.getElementById('roomsContainer').prepend(fs);
    renderTasks(idx, roomList[0]);
    loadCustomTasks(idx);
    const photoData = loadRoomPhoto(idx);
    if (photoData) insertPhotoPreview(idx, photoData);

    localStorage.setItem('roomCount', roomCount);
  });

  function addCustomTask(idx) {
    const container = document.getElementById(`tasks-${idx}`);
    const div = document.createElement('div'); div.className = 'task-item';
    const lbl = document.createElement('label');
    const cb = document.createElement('input'); cb.type = 'checkbox';
    const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'Custom task'; inp.style.flex = '1'; inp.style.marginLeft = '8px';
    lbl.append(cb, inp);
    const ctr = document.createElement('div'); ctr.className = 'task-controls';
    const sel = document.createElement('select');
    ['Dispose','Bring to shop','Store on site'].forEach(opt => {
      const o = document.createElement('option'); o.value = opt; o.textContent = opt; sel.append(o);
    });
    sel.style.display = 'none';
    cb.addEventListener('change', () => {
      sel.style.display = cb.checked ? 'block' : 'none';
      saveCustomTasks(idx);
    });
    inp.addEventListener('input', () => saveCustomTasks(idx));
    ctr.append(sel);
    div.append(lbl, ctr);
    container.append(div);
  }

  // ... rest of your working code (renderTasks, PDF conversions, Work Order modal, etc.) remains unchanged

  // ===== Restore rooms on load =====
  const savedRoomCount = +localStorage.getItem('roomCount') || 0;
  for (let i = 0; i < savedRoomCount; i++) {
    document.getElementById('addRoomBtn').click();
  }

  // ... existing capture location & other logic unchanged

});
</script>
</body>
</html>

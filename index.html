<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Interior Elite Demolition Walkthrough v1.8</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body { font-family:'Montserrat',sans-serif; background:#f0f0f0; color:#333; margin:0; padding:0; }
    .header { background:#ff8c00; color:#fff; display:flex; align-items:center; padding:12px 24px; }
    .header img { height:48px; margin-right:16px; }
    .header h1 { font-size:1.6rem; margin:0; }
    .container { max-width:800px; margin:24px auto; padding:20px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h2 { text-align:center; color:#ff8c00; margin-bottom:24px; }
    fieldset { border:1px solid #ddd; border-radius:8px; margin-bottom:20px; padding:15px; }
    legend { font-weight:600; font-size:1.1rem; color:#444; }
    label { display:block; margin-bottom:6px; font-weight:500; }
    input, select, textarea { width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px; }
    textarea { min-height:60px; resize:vertical; }
    .btn { display:block; width:100%; padding:12px; border:none; border-radius:4px; font-weight:600; cursor:pointer; margin-bottom:12px; }
    .btn-primary { background:#ff8c00; color:#fff; }
    .btn-primary:hover { background:#e67600; }
    .btn-custom { background:#444; color:#fff; }
    .btn-custom:hover { background:#333; }
    .btn-secondary { background:#007acc; color:#fff; }
    .btn-secondary:hover { background:#006bb3; }
    .personnel-item, .checklist-item, .task-item { display:flex; flex-wrap:wrap; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee; }
    .note-input { display:none; margin-top:6px; }
    .sig-field { margin:16px 0; }
    .sig-field canvas { border:1px solid #ccc; border-radius:4px; display:block; width:100%; max-width:400px; height:120px; }
    .room-photo-preview { max-width:200px; display:block; margin:10px 0; border:1px solid #ccc; }
    .footer { text-align:center; padding:12px; font-size:0.85rem; color:#666; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

</head>
<body>
  <header class="header">
    <img src="https://kamloopsbuilders.ca/assets/logo.png" alt="Kamloops Builders Logo"/>
    <h1>Interior Elite Demolition Walkthrough</h1>
  </header>
  <div class="container" id="mainContainer">
    <h2>Demolition Walkthrough v1.8</h2>
    <p><strong>Timestamp:</strong> <span id="formTimestamp"></span></p>
    <form id="demoForm">
      <!-- Project Info -->
      <fieldset><legend>Project Info</legend>
        <label>Site Address<input id="siteAddress" type="text" placeholder="Enter site address"></label>
        <label>Client Name<input id="clientName" type="text" placeholder="Enter client name"></label>
        <button type="button" id="captureLocationBtn" class="btn btn-custom">Capture Site Location</button>
        <div id="siteLocationDisplay" style="font-size:0.9rem;color:#555;"></div>
      </fieldset>
      <!-- Personnel -->
      <fieldset><legend>Personnel on Site</legend>
        <button type="button" id="addPersonnelBtn" class="btn btn-primary">+ Add Personnel</button>
        <div id="personnelContainer"></div>
      </fieldset>
      <!-- Checklists -->
      <fieldset><legend>Site Conditions</legend><div id="siteConditionsList"></div></fieldset>
      <fieldset><legend>Site Security</legend><div id="siteSecurityList"></div></fieldset>
      <fieldset><legend>Special Client Requests</legend><div id="specialRequestsList"></div></fieldset>
      <!-- Rooms & Tasks -->
      <fieldset><legend>Rooms & Tasks</legend>
        <button type="button" id="addRoomBtn" class="btn btn-primary">+ Add Room</button>
        <div id="roomsContainer"></div>
      </fieldset>
      <!-- Signatures & Save -->
      <div id="signatureContainer"></div>
      <button type="button" id="saveJpgBtn" class="btn btn-secondary" style="display:none;">Save copy of form</button>
    </form>
  </div>
  <div class="footer">&copy; 2025 Kamloops Builders • All rights reserved</div>

  <script>
// Entire form logic wrapped in DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // ===== AUTO-TIMESTAMP =====
  document.getElementById('formTimestamp').textContent = new Date().toLocaleString();

  // ===== SIGNATURE PADS SETUP =====
  window.sigPads = [];
  const peopleTypes = ["Project Manager","Designer","Client"];
  let personnelCount = 0;

  function updateSaveBtn() {
    const btn = document.getElementById('saveJpgBtn');
    // show only if at least one pad and all have ink
    btn.style.display = (sigPads.length && sigPads.every(p=>!p.isEmpty())) ? 'block' : 'none';
  }

  // Add Personnel + inline signature pad
  document.getElementById('addPersonnelBtn').addEventListener('click', () => {
    const idx = personnelCount++;
    // Create personnel row
    const container = document.getElementById('personnelContainer');
    const divP = document.createElement('div'); divP.className = 'personnel-item';
    const sel = document.createElement('select'); sel.name = `personnel[${idx}][role]`;
    peopleTypes.forEach(pt=>{
      const opt = document.createElement('option'); opt.value=pt; opt.textContent=pt; sel.appendChild(opt);
    });
    const inName = document.createElement('input'); inName.type='text'; inName.name=`personnel[${idx}][name]`; inName.placeholder='Name';
    const inPhone = document.createElement('input'); inPhone.type='tel'; inPhone.name=`personnel[${idx}][phone]`; inPhone.placeholder='Phone';
    divP.append(sel,inName,inPhone);
    container.appendChild(divP);

    // Signature field
    const sigDiv = document.createElement('div'); sigDiv.className='sig-field';
    sigDiv.innerHTML = `
      <label>Signature ${idx+1}:</label>
      <canvas id="sigCanvas_${idx}" width="400" height="120"></canvas>
      <button type="button" id="clearSig_${idx}">Clear</button>
    `;
    document.getElementById('signatureContainer').appendChild(sigDiv);

    const canvas = document.getElementById(`sigCanvas_${idx}`);
    const pad = new SignaturePad(canvas, {backgroundColor:'rgba(255,255,255,0)'});
    window.sigPads.push(pad);

    // Clear & update logic
    document.getElementById(`clearSig_${idx}`).addEventListener('click', () => { pad.clear(); updateSaveBtn(); });
    canvas.addEventListener('mouseup', updateSaveBtn);
    canvas.addEventListener('touchend', updateSaveBtn);
    updateSaveBtn();
  });

  // ===== JPEG EXPORT BUTTON =====
  document.getElementById('saveJpgBtn').addEventListener('click', () => {
    html2canvas(document.getElementById('mainContainer'), {scale:2, backgroundColor:'#fff'})
      .then(canvas => {
        const link = document.createElement('a');
        link.download = 'Demolition_Walkthrough.jpg';
        link.href = canvas.toDataURL('image/jpeg',0.95);
        link.click();
      });
  });

  // ===== CHECKLIST GENERATOR =====
  function generateChecklist(id, opts) {
    const c = document.getElementById(id);
    opts.forEach((opt,i)=>{
      const div = document.createElement('div'); div.className='checklist-item';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.id=`${id}-chk-${i}`; chk.value=opt;
      const lbl = document.createElement('label'); lbl.htmlFor=chk.id; lbl.textContent=opt;
      const note = document.createElement('input'); note.type='text'; note.placeholder='Notes (optional)';
      note.className='note-input'; note.id=`${id}-note-${i}`;
      chk.addEventListener('change', ()=> note.style.display = chk.checked ? 'block' : 'none');
      div.append(chk,lbl,note);
      c.appendChild(div);
    });
  }

  const siteConditionsOptions = [
    "Site access restrictions","Ground conditions (muddy/rocky)","Water accumulation","Overhead hazards",
    "Confined space","Noise sensitive area","Dust control measures","Traffic control required",
    "Environmental protection zones","Asbestos identified","Lead paint identified","High wind exposure",
    "Sloped terrain","Restricted working hours","Weather forecast monitoring"
  ];
  const siteSecurityOptions = [
    "Perimeter fencing","Lockable gates","Warning signage","CCTV surveillance","Temporary lighting",
    "Security guards","Access logs","Alarm systems","Fire watch","Visitor log","Key control",
    "Lockout/tagout","Exit signage","Barriers"
  ];
  const specialRequestsOptions = [
    "Salvage materials","Furniture protection","Debris staging","Separate waste streams","Client liaison",
    "Restricted hours","Noise mitigation","Dust suppression","Landscaping protect","Structure protect",
    "Third party coord","Photo documentation"
  ];

  generateChecklist('siteConditionsList', siteConditionsOptions);
  generateChecklist('siteSecurityList', siteSecurityOptions);
  generateChecklist('specialRequestsList', specialRequestsOptions);

  // ===== ROOM & TASK LOGIC =====
  const roomList = [
    "Bathroom","Kitchen","Living Room","Bedroom","Dining Room","Home Office","Laundry Room","Garage",
    "Basement","Attic","Patio","Deck","Porch","Hallway","Entryway","Staircase","Exterior Walls",
    "Driveway","Sidewalk","Landscaping Area","Roof"
  ];
  const standardTasks = [
    "Remove wall drywall","Remove ceiling drywall","Remove flooring","Remove doors","Remove trim/moulding",
    "Remove baseboard trim","Asbestos review","Disconnect utilities","General cleanup","Debris removal"
  ];
  const roomSpecificTasks = {
    "Bathroom":["Remove toilet","Remove bathtub/shower","Remove vanity","Remove countertop","Remove sink","Remove mirror","Remove medicine cabinet","Remove tile from walls","Remove tile from floor","Remove plumbing fixtures"],
    "Kitchen":["Remove cabinets","Remove countertops","Remove sink","Remove faucet","Remove appliances","Remove backsplash tile","Remove lighting fixtures","Remove island","Remove hood","Remove dishwasher"],
    "Living Room":["Remove drywall","Remove flooring","Remove trim","Remove baseboards","Remove windows","Remove built-in shelves","Remove fireplace","Remove lighting fixtures","Remove wall coverings","Remove vents"],
    "Bedroom":["Remove drywall","Remove flooring","Remove trim","Remove baseboards","Remove windows","Remove closet shelving","Remove lighting fixtures","Remove built-in furniture","Remove outlets","Remove vents"],
    "Dining Room":["Remove drywall","Remove flooring","Remove trim","Remove baseboards","Remove lighting fixtures","Remove built-in features","Remove chandelier","Remove paint","Remove curtains","Remove outlets"],
    "Home Office":["Remove drywall","Remove flooring","Remove trim","Remove baseboards","Remove built-in desks","Remove lighting fixtures","Remove data outlets","Remove shelving","Remove whiteboards","Remove outlets"],
    "Laundry Room":["Remove washer/dryer","Remove cabinets","Remove sink","Remove plumbing fixtures","Remove flooring","Remove lighting fixtures","Remove ventilation fan","Remove tile","Remove shelving","Remove outlets"],
    "Garage":["Remove drywall","Remove shelving","Remove cabinets","Remove doors","Remove windows","Remove lighting fixtures","Remove electrical fixtures","Remove insulation","Remove hooks","Remove signage"],
    "Basement":["Remove drywall","Remove flooring","Remove insulation","Remove trim","Remove lighting fixtures","Remove windows","Remove sump pump cover","Remove tile","Remove shelving","Remove outlets"],
    "Attic":["Remove insulation","Remove drywall","Remove flooring","Remove vents","Remove lighting fixtures","Remove bracing","Remove panels","Remove wiring","Remove ductwork","Remove hatch"],
    "Patio":["Remove pavers","Remove decking","Remove railings","Remove lighting fixtures","Remove outdoor furniture","Remove pergola","Remove planters","Remove fixtures","Remove coverings","Remove posts"],
    "Deck":["Remove deck boards","Remove railings","Remove stairs","Remove lighting fixtures","Remove posts","Remove joists","Remove skirting","Remove hardware","Remove fascia","Remove supports"],
    "Porch":["Remove flooring","Remove railings","Remove columns","Remove lighting fixtures","Remove door frame","Remove ceiling","Remove trim","Remove steps","Remove fixtures","Remove soffit"],
    "Hallway":["Remove drywall","Remove flooring","Remove trim","Remove baseboards","Remove lighting fixtures","Remove railings","Remove sconces","Remove outlets","Remove vents","Remove doors"],
    "Entryway":["Remove flooring","Remove trim","Remove lighting fixtures","Remove closet shelving","Remove doors","Remove hardware","Remove baseboards","Remove outlets","Remove vents","Remove paint"],
    "Staircase":["Remove treads","Remove risers","Remove handrails","Remove balusters","Remove lighting fixtures","Remove carpet","Remove hardware","Remove trim","Remove landing","Remove fixture"],
    "Exterior Walls":["Remove cladding","Remove siding","Remove fascia","Remove soffit","Remove windows","Remove trim","Remove vents","Remove fixtures","Remove caulking","Remove flashings"],
    "Driveway":["Remove concrete","Remove asphalt","Remove pavers","Remove sealant","Remove markings","Remove curbing","Remove debris","Remove expansion joints","Remove edging","Remove gravel"],
    "Sidewalk":["Remove concrete","Remove pavers","Remove curb","Remove sealant","Remove debris","Remove expansion joints","Remove edging","Remove fixtures","Remove paint","Remove weeds"],
    "Landscaping Area":["Remove plants","Remove mulch","Remove edging","Remove debris","Remove topsoil","Remove pipes","Remove fences","Remove planters","Remove irrigation","Remove fixtures"],
    "Roof":["Remove shingles","Remove underlayment","Remove flashing","Remove gutters","Remove downspouts","Remove vents","Remove skylights","Remove decking","Remove hardware","Remove insulation"]
  };

  // Helpers: photo & task persistence
  function saveRoomPhoto(idx,dataURL){ localStorage.setItem(`room-${idx}-photo`,dataURL); }
  function loadRoomPhoto(idx){ return localStorage.getItem(`room-${idx}-photo`); }
  function insertPhotoPreview(idx,dataURL){
    const fs=document.getElementById(`room-${idx}`), img=fs.querySelector('img.room-photo-preview') || (()=>{ const i=document.createElement('img'); i.className='room-photo-preview'; fs.appendChild(i); return i; })();
    img.src=dataURL;
  }
  function saveCustomTasks(idx){
    const arr=Array.from(document.querySelectorAll(`#tasks-${idx} .task-item`))
      .filter(it=>it.querySelector('input[type="text"]'))
      .map(it=>({
        text:it.querySelector('input[type="text"]').value,
        checked:it.querySelector('input[type="checkbox"]').checked,
        disposition:it.querySelector('select').value
      }));
    localStorage.setItem(`room-${idx}-customTasks`, JSON.stringify(arr));
  }
  function loadCustomTasks(idx){
    JSON.parse(localStorage.getItem(`room-${idx}-customTasks`)||'[]').forEach(td=>{
      addCustomTask(idx);
      const last=document.querySelector(`#tasks-${idx} .task-item:last-child`);
      last.querySelector('input[type="text"]').value=td.text;
      last.querySelector('input[type="checkbox"]').checked=td.checked;
      const sel=last.querySelector('select');
      if(td.checked) sel.style.display='block';
      sel.value=td.disposition;
    });
  }

  // Render standard + specific tasks
  function renderTasks(idx,type){
    const cont=document.getElementById(`tasks-${idx}`); cont.innerHTML='';
    const tasks=standardTasks.concat(roomSpecificTasks[type]||[]);
    tasks.forEach(task=>{
      const div=document.createElement('div'); div.className='task-item';
      const lbl=document.createElement('label');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.value=task;
      lbl.append(cb,document.createTextNode(task));
      const ctr=document.createElement('div'); ctr.className='task-controls';
      const sel=document.createElement('select');
      ['Dispose','Bring to shop','Store on site'].forEach(opt=>{
        const o=document.createElement('option'); o.value=opt; o.textContent=opt; sel.appendChild(o);
      });
      sel.style.display='none';
      cb.addEventListener('change',()=>sel.style.display=cb.checked?'block':'none');
      ctr.appendChild(sel); div.append(lbl,ctr);
      cont.append(div);
    });
  }

  function addCustomTask(idx){
    const cont=document.getElementById(`tasks-${idx}`);
    const div=document.createElement('div'); div.className='task-item';
    const lbl=document.createElement('label');
    const cb=document.createElement('input'); cb.type='checkbox';
    const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Custom task'; inp.style.flex='1'; inp.style.marginLeft='8px';
    lbl.append(cb,inp);
    const ctr=document.createElement('div'); ctr.className='task-controls';
    const sel=document.createElement('select');
    ['Dispose','Bring to shop','Store on site'].forEach(opt=>{
      const o=document.createElement('option'); o.value=opt; o.textContent=opt; sel.appendChild(o);
    });
    sel.style.display='none';
    cb.addEventListener('change',()=>sel.style.display=cb.checked?'block':'none');
    inp.addEventListener('input',()=>saveCustomTasks(idx));
    div.append(lbl,ctr); ctr.appendChild(sel); cont.appendChild(div);
  }

  // Add Room
  let roomCount=0;
  document.getElementById('addRoomBtn').addEventListener('click',()=>{
    const idx=roomCount++;
    const fs=document.createElement('fieldset'); fs.id=`room-${idx}`;
    const lg=document.createElement('legend'); lg.textContent=`Room ${idx+1}`; fs.appendChild(lg);

    const sel=document.createElement('select'); sel.name=`rooms[${idx}][type]`;
    roomList.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
    sel.addEventListener('change',()=>{ renderTasks(idx,sel.value); loadCustomTasks(idx); const p=loadRoomPhoto(idx); if(p) insertPhotoPreview(idx,p); });
    fs.appendChild(sel);

    const photo=document.createElement('input'); photo.type='file'; photo.accept='image/*'; photo.capture='environment';
    photo.addEventListener('change',()=>{
      const f=photo.files[0]; if(f){
        const reader=new FileReader();
        reader.onload=e=>{ saveRoomPhoto(idx,e.target.result); insertPhotoPreview(idx,e.target.result); };
        reader.readAsDataURL(f);
      }
    });
    fs.appendChild(photo);

    const tasksDiv=document.createElement('div'); tasksDiv.id=`tasks-${idx}`; fs.appendChild(tasksDiv);
    const cbtn=document.createElement('button'); cbtn.type='button'; cbtn.className='btn btn-custom'; cbtn.textContent='+ Custom Task';
    cbtn.addEventListener('click',()=>{ addCustomTask(idx); saveCustomTasks(idx); });
    fs.appendChild(cbtn);

    document.getElementById('roomsContainer').appendChild(fs);
    renderTasks(idx,roomList[0]);
    loadCustomTasks(idx);
    const st=loadRoomPhoto(idx); if(st) insertPhotoPreview(idx,st);

    localStorage.setItem('roomCount',roomCount);
  });

  // Geolocation
  document.getElementById('captureLocationBtn').addEventListener('click',()=>{
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      document.getElementById('siteLocationDisplay').textContent=
        `Latitude: ${pos.coords.latitude.toFixed(6)}, Longitude: ${pos.coords.longitude.toFixed(6)}`;
    }, err=>alert('Unable to retrieve location: '+err.message));
  });

  // Restore on reload
  document.getElementById('siteAddress').value = localStorage.getItem('siteAddress')||'';
  document.getElementById('clientName').value = localStorage.getItem('clientName')||'';
  const savedRC = +localStorage.getItem('roomCount')||0;
  for(let i=0;i<savedRC;i++){ document.getElementById('addRoomBtn').click(); }

  // Wipe old storage on unload
  window.addEventListener('beforeunload', ()=>{
    localStorage.setItem('siteAddress',document.getElementById('siteAddress').value);
    localStorage.setItem('clientName',document.getElementById('clientName').value);
  });

  // ===== WORK ORDER MODAL & EXPORT =====
  const toWO = document.getElementById('toWorkOrderBtn');
  toWO.addEventListener('click', ()=> {
    // build modal overlay
    const old = document.getElementById('workOrderModal'); if(old) old.remove();
    const overlay = document.createElement('div'); overlay.id='workOrderModal';
    Object.assign(overlay.style,{
      position:'fixed',top:0,left:0,width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)',zIndex:9999,
      display:'flex',justifyContent:'center',alignItems:'flex-start',overflowY:'auto',padding:'2vh'
    });
    const modal = document.createElement('div');
    Object.assign(modal.style,{background:'#fff',borderRadius:'12px',padding:'20px',maxWidth:'800px',width:'100%'});
    modal.innerHTML = `
      <button id="closeWOModal" style="float:right;font-size:1.5em;border:none;background:none;">&times;</button>
      <h2 style="color:#ff8c00;">Work Order Summary</h2>
      <div id="accordionSectionContainer"></div>
      <h3 style="margin-top:20px;">Room Tasks</h3>
      <div id="roomTasksContainer"></div>
      <h3 style="margin-top:20px;">Digital Sign-off</h3>
      <canvas id="woSigCanvas" width="400" height="120" style="border:1px solid #ccc;border-radius:6px;"></canvas>
      <input type="text" id="woSignName" placeholder="Printed Name" style="width:100%;margin-top:10px;padding:6px;"/>
      <input type="date" id="woSignDate" style="width:100%;margin-top:6px;padding:6px;"/>
      <div style="text-align:right;margin-top:20px;">
        <button id="woPdfBtn" class="btn btn-secondary">Download PDF</button>
        <button id="woEmailBtn" class="btn btn-primary">Email Checklist</button>
      </div>`;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Close handler
    document.getElementById('closeWOModal').onclick = ()=>overlay.remove();

    // Accordion sections
    [
      ['Site Conditions','siteConditionsList'],
      ['Site Security','siteSecurityList'],
      ['Special Client Requests','specialRequestsList']
    ].forEach(([title,id])=>{
      const acc = document.createElement('div'); acc.style.margin='10px 0';
      const btn=document.createElement('button');
      Object.assign(btn.style,{width:'100%',textAlign:'left',padding:'10px',background:'#f7f7f7',border:'1px solid #ccc',borderRadius:'4px'});
      btn.textContent=title;
      const content=document.createElement('div');
      Object.assign(content.style,{display:'none',padding:'10px',border:'1px solid #ccc',borderTop:'none'});
      document.querySelectorAll(`#${id} .checklist-item input[type="checkbox"]`).forEach(chk=>{
        if(chk.checked){
          const lbl=chk.nextSibling.textContent.trim();
          const note=document.getElementById(`${id}-note-${chk.id.split('-').pop()}`).value;
          const row=document.createElement('div'); row.style.marginBottom='8px';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true;
          row.append(cb,' '+lbl);
          if(note){ const p=document.createElement('p'); p.textContent='Note: '+note; p.style.marginLeft='24px'; p.style.color='#555'; row.appendChild(p); }
          content.appendChild(row);
        }
      });
      btn.onclick=()=>content.style.display = content.style.display==='none'?'block':'none';
      acc.append(btn,content);
      document.getElementById('accordionSectionContainer').appendChild(acc);
    });

    // Room tasks
    document.querySelectorAll('#roomsContainer fieldset').forEach(fs=>{
      const roomName=fs.querySelector('select').value;
      const checkedItems=Array.from(fs.querySelectorAll('.task-item'))
        .filter(it=>it.querySelector('input[type="checkbox"]').checked);
      if(!checkedItems.length) return;
      const section=document.createElement('div'); section.style.marginBottom='20px';
      const h4=document.createElement('h4'); h4.textContent=roomName; section.appendChild(h4);
      const ul=document.createElement('ul'); ul.className='sortable-tasks'; ul.style.paddingLeft='20px';
      checkedItems.forEach(it=>{
        const li=document.createElement('li');
        li.setAttribute('draggable','true');
        Object.assign(li.style,{marginBottom:'10px',padding:'6px',border:'1px solid #ccc',borderRadius:'6px',background:'#f9f9f9',cursor:'grab'});
        const lbl=it.querySelector('label').textContent.trim();
        const disp=it.querySelector('select')?.value||'';
        li.textContent=`${lbl} — ${disp}`;
        // note inside task
        const note=it.querySelector('textarea')?.value;
        if(note){ const p=document.createElement('p'); p.textContent='Note: '+note; p.style.marginLeft='12px'; p.style.color='#555'; li.appendChild(p); }
        ul.appendChild(li);
      });
      // photo
      const inp=fs.querySelector('input[type="file"]');
      if(inp&&inp.files[0]){
        const reader=new FileReader();
        reader.onload=e=>{
          const img=document.createElement('img');
          img.src=e.target.result; img.style.maxWidth='150px'; img.style.display='block'; img.style.marginTop='6px';
          section.appendChild(img);
        };
        reader.readAsDataURL(inp.files[0]);
      }
      section.appendChild(ul);
      document.getElementById('roomTasksContainer').appendChild(section);
    });

    // Enable drag-drop
    document.querySelectorAll('.sortable-tasks').forEach(ul=>{
      let dragEl=null;
      ul.addEventListener('dragstart',e=>{ dragEl=e.target; e.dataTransfer.effectAllowed='move'; });
      ul.addEventListener('dragover',e=>{
        e.preventDefault();
        const tgt=e.target.closest('li');
        if(tgt && tgt!==dragEl){
          const rect=tgt.getBoundingClientRect();
          const after=(e.clientY-rect.top)/(rect.bottom-rect.top)>0.5;
          tgt.parentNode.insertBefore(dragEl, after?tgt.nextSibling:tgt);
        }
      });
    });

    // Modal signature pad
    const modalPad = new SignaturePad(document.getElementById('woSigCanvas'));

    // PDF export
    document.getElementById('woPdfBtn').addEventListener('click',()=>{
      html2canvas(modal,{scale:2,backgroundColor:'#fff'}).then(c=>{
        const link=document.createElement('a'); link.download='Work_Order.pdf'; link.href=c.toDataURL('image/png'); link.click();
      });
    });

    // Email summary
    document.getElementById('woEmailBtn').addEventListener('click',()=>{
      let body='';
      overlay.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>{
        body+=cb.parentElement.textContent.trim()+'\n';
      });
      const nm=document.getElementById('woSignName').value;
      const dt=document.getElementById('woSignDate').value;
      body+=`\nSigned by: ${nm} on ${dt}`;
      window.location.href=`mailto:?subject=Work Order Checklist&body=${encodeURIComponent(body)}`;
    });
  });
</script>

</body>
</html>
